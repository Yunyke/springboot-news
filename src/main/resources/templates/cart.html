<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>📰 新聞牆 – Facebook Style</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: #f0f2f5;
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 0;
    }

    .feed-container {
      max-width: 720px;
      margin: 0 auto;
      padding: 1.5rem 1rem;
    }

    .news-feed-card {
      background-color: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-bottom: 1.5rem;
      padding: 1rem 1.25rem;
      transition: box-shadow 0.2s ease-in-out;
    }

    .news-feed-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }

    .news-feed-title {
      font-size: 1.25rem;
      font-weight: bold;
      color: #1c1e21;
      margin-bottom: 0.5rem;
    }

    .news-feed-img {
      width: 100%;
      max-height: 360px;
      object-fit: cover;
      border-radius: 10px;
      margin: 0.75rem 0;
    }

    .news-feed-desc {
      font-size: 1rem;
      color: #333;
      line-height: 1.5;
      margin-bottom: 0.75rem;
    }

    .news-feed-time {
      font-size: 0.85rem;
      color: #777;
    }

    .news-feed-content {
      display: none;
      margin-top: 0.75rem;
      white-space: pre-wrap;
      color: #333;
      font-size: 0.95rem;
      line-height: 1.6;
    }

    .news-feed-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.75rem;
    }

    @media (max-width: 576px) {
      .news-feed-card {
        padding: 1rem;
      }

      .news-feed-title {
        font-size: 1.1rem;
      }

      .news-feed-desc {
        font-size: 0.95rem;
      }
    }
  </style>
</head>

<body onload="loadCart()">

<main class="feed-container">
  <h1 class="text-center mb-4">📰 我的新聞牆</h1>

  <div id="cart-content">
    <!-- 請求資料後這裡會被填滿 -->
  </div>
</main>

<script>
function loadCart() {
  const ids = JSON.parse(localStorage.getItem("newsCart") || "[]")
              .filter(id => Number.isInteger(id) && id > 0);

  if (ids.length === 0) {
    document.getElementById("cart-content").innerHTML = `
      <p class="text-center text-muted mt-5">📭 目前沒有收藏新聞</p>`;
    return;
  }

  fetch("/cart/load", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(ids)
  })
  .then(res => res.text())
  .then(html => {
    document.getElementById("cart-content").innerHTML = html;

    // 綁定移除
    document.querySelectorAll(".remove-from-cart-btn").forEach(btn => {
      btn.addEventListener("click", function () {
        const id = parseInt(this.dataset.id);
        let cart = JSON.parse(localStorage.getItem("newsCart") || "[]");
        cart = cart.filter(item => item !== id);
        localStorage.setItem("newsCart", JSON.stringify(cart));
        loadCart();
      });
    });

    // 綁定展開全文
    document.querySelectorAll(".toggle-content-btn").forEach(btn => {
      btn.addEventListener("click", function () {
        const content = this.closest(".news-feed-card").querySelector(".news-feed-content");
        const isShown = content.style.display === "block";
        content.style.display = isShown ? "none" : "block";
        this.textContent = isShown ? "閱讀全文" : "收起全文";
      });
    });
  });
}
</script>

<!-- Thymeleaf Fragment for cart -->
<div th:fragment="cartFragment">
  <div th:each="news : ${cartNews}" class="news-feed-card">
    <img th:if="${news.imageUrl}" th:src="${news.imageUrl}" class="news-feed-img" />

    <div class="news-feed-title" th:text="${news.title}">標題</div>

    <div class="news-feed-desc" th:text="${news.description}">摘要</div>

    <div class="news-feed-time" th:text="${#temporals.format(news.publishedAt, 'yyyy-MM-dd HH:mm')}">時間</div>

    <!-- ✅ 新增：內文 -->
    <div class="news-feed-content" th:if="${news.content}" th:text="${news.content}">內文</div>

    <div class="news-feed-actions">
      <button class="btn btn-sm btn-outline-primary toggle-content-btn">閱讀全文</button>
      <button class="btn btn-sm btn-outline-danger remove-from-cart-btn" th:attr="data-id=${news.id}">移除</button>
    </div>
  </div>
</div>

</body>
</html>
